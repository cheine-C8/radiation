import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Radio, Activity, Shield, Zap, Settings } from 'lucide-react';

const RadiationDemo = () => {
  const canvasRef = useRef(null);
  const [radiationType, setRadiationType] = useState('alpha');
  const [barrierType, setBarrierType] = useState('none');
  const [isPlaying, setIsPlaying] = useState(true);
  const [selectedUnit, setSelectedUnit] = useState('cpm');
  
  // New Metrics State
  const [metrics, setMetrics] = useState({
    cpm: 0,
    cps: 0,
    uSv: 0,
    mrh: 0,
    total: 0
  });

  // Simulation constants
  const BARRIER_X = 400;
  const DETECTOR_X = 700;
  const CANVAS_WIDTH = 800;
  const CANVAS_HEIGHT = 400;

  // Refs for simulation state (avoids re-renders during high-speed physics)
  const particlesRef = useRef([]);
  const animationRef = useRef(null);
  const lastSpawnTimeRef = useRef(0);
  const lastHitTimeRef = useRef(0);
  const hitHistoryRef = useRef([]); // Stores timestamps of hits for CPM calc
  const totalCountRef = useRef(0);  // Stores total raw count

  // Configuration for different radiation types
  const CONFIG = {
    alpha: {
      speed: 2,
      spawnRate: 300, // ms between spawns
      color: '#FF5252',
      radius: 6,
      label: 'Alpha (α)',
      desc: 'Helium nuclei (2 protons, 2 neutrons). Large mass, +2 charge. Low penetration.',
      blockedBy: ['paper', 'aluminum', 'lead']
    },
    beta: {
      speed: 5,
      spawnRate: 150,
      color: '#448AFF',
      radius: 3,
      label: 'Beta (β)',
      desc: 'High-energy electrons. Low mass, -1 charge. Medium penetration.',
      blockedBy: ['aluminum', 'lead']
    },
    gamma: {
      speed: 8,
      spawnRate: 100,
      color: '#69F0AE',
      radius: 2, // drawn as wave
      label: 'Gamma (γ)',
      desc: 'High-energy photons/waves. No mass, no charge. High penetration.',
      blockedBy: ['lead']
    }
  };

  const BARRIERS = {
    none: { width: 0, color: 'transparent', label: 'None' },
    paper: { width: 5, color: '#FFFFFF', label: 'Paper' },
    aluminum: { width: 15, color: '#90A4AE', label: 'Aluminum' },
    lead: { width: 40, color: '#37474F', label: 'Lead' }
  };

  // Unit definitions for the selector
  const UNITS = {
    cpm: { label: 'CPM', name: 'Counts Per Minute', color: 'text-green-400' },
    cps: { label: 'CPS', name: 'Counts Per Second', color: 'text-blue-400' },
    uSv: { label: 'μSv/h', name: 'Microsieverts/hr', color: 'text-yellow-400' },
    mrh: { label: 'mR/h', name: 'Milliroentgens/hr', color: 'text-orange-400' }
  };

  // --- METER LOGIC ---
  useEffect(() => {
    // Update the meter readings every 500ms based on hit history
    const interval = setInterval(() => {
        const now = Date.now();
        const WINDOW_MS = 3000; // 3 second sliding window for rate calculation
        
        // Prune old hits
        hitHistoryRef.current = hitHistoryRef.current.filter(t => now - t < WINDOW_MS);
        
        // Calculate raw rates
        const hitsInWindow = hitHistoryRef.current.length;
        const currentCPM = Math.round((hitsInWindow / (WINDOW_MS / 1000)) * 60);
        const currentCPS = (hitsInWindow / (WINDOW_MS / 1000)).toFixed(1);
        
        // Convert to Dose equivalents (Approximate for simulation)
        // ~150 CPM = 1 uSv/h (Cesium-137 standard)
        const uSv = (currentCPM / 150).toFixed(2);
        
        // ~1200 CPM = 1 mR/h (Typical GM tube)
        const mrh = (currentCPM / 1200).toFixed(3);

        setMetrics({
            cpm: currentCPM,
            cps: currentCPS,
            uSv: uSv,
            mrh: mrh,
            total: totalCountRef.current
        });

    }, 200); // Faster update rate for smoother feel

    return () => clearInterval(interval);
  }, []);

  const spawnParticle = () => {
    const config = CONFIG[radiationType];
    const spawnY = CANVAS_HEIGHT / 2 + (Math.random() - 0.5) * 40;
    
    particlesRef.current.push({
      x: 85, 
      y: spawnY,
      vx: config.speed,
      type: radiationType,
      active: true,
      waveOffset: Math.random() * 100,
      id: Date.now() + Math.random()
    });
  };

  const checkCollision = (particle) => {
    if (barrierType === 'none') return false;
    const barrierConfig = BARRIERS[barrierType];
    const ABSORPTION_RATES = {
        alpha: { paper: 0.8, aluminum: 1.0, lead: 1.0 },
        beta: { paper: 0.05, aluminum: 0.5, lead: 1.0 },
        gamma: { paper: 0.0, aluminum: 0.05, lead: 0.35 }
    };

    if (particle.x >= BARRIER_X - barrierConfig.width/2 && 
        particle.x <= BARRIER_X + barrierConfig.width/2) {
      
      const rate = ABSORPTION_RATES[particle.type][barrierType];
      if (Math.random() < rate) return true;
    }
    return false;
  };

  // Helper to draw the rounded rectangle for the emitter
  const roundRect = (ctx, x, y, w, h, r) => {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  };

  const update = (timestamp) => {
    if (!isPlaying) return;

    const ctx = canvasRef.current?.getContext('2d');
    if (!ctx) return;

    ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

    // --- DRAW EMITTER ---
    const sourceY = CANVAS_HEIGHT / 2;
    const gradBody = ctx.createLinearGradient(0, sourceY - 50, 0, sourceY + 50);
    gradBody.addColorStop(0, '#2a2a2a');
    gradBody.addColorStop(0.5, '#4a4a4a');
    gradBody.addColorStop(1, '#2a2a2a');
    ctx.fillStyle = gradBody;
    roundRect(ctx, 10, sourceY - 45, 70, 90, 10);
    ctx.fill();
    
    // Hazard Stripes
    ctx.save();
    ctx.clip();
    ctx.fillStyle = '#EAB308';
    ctx.fillRect(10, sourceY - 35, 70, 70);
    ctx.fillStyle = '#000';
    for(let i = 0; i < 10; i++) {
        ctx.beginPath();
        ctx.moveTo(10, sourceY - 35 + (i*15));
        ctx.lineTo(80, sourceY - 35 + (i*15) - 20);
        ctx.lineTo(80, sourceY - 35 + (i*15) - 10);
        ctx.lineTo(10, sourceY - 35 + (i*15) + 10);
        ctx.fill();
    }
    ctx.restore();

    // Nozzle
    const gradNozzle = ctx.createLinearGradient(60, sourceY, 90, sourceY);
    gradNozzle.addColorStop(0, '#333');
    gradNozzle.addColorStop(1, '#111');
    ctx.fillStyle = gradNozzle;
    ctx.beginPath();
    ctx.moveTo(75, sourceY - 20);
    ctx.lineTo(95, sourceY - 12);
    ctx.lineTo(95, sourceY + 12);
    ctx.lineTo(75, sourceY + 20);
    ctx.fill();
    
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(95, sourceY, 5, 12, 0, 0, Math.PI*2);
    ctx.fill();

    // Trefoil
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(45, sourceY, 5, 0, Math.PI * 2);
    ctx.fill();
    for(let i=0; i<3; i++) {
        ctx.beginPath();
        ctx.moveTo(45, sourceY);
        ctx.arc(45, sourceY, 22, (i * 2 * Math.PI / 3) - 0.5, (i * 2 * Math.PI / 3) + 0.5);
        ctx.lineTo(45, sourceY);
        ctx.fill();
    }


    // --- DRAW BARRIER ---
    if (barrierType !== 'none') {
      const b = BARRIERS[barrierType];
      ctx.fillStyle = b.color;
      ctx.fillRect(BARRIER_X - b.width/2, 100, b.width, 200);
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fillRect(BARRIER_X + b.width/2, 100, 10, 200);
      ctx.beginPath();
      ctx.moveTo(BARRIER_X - b.width/2, 100);
      ctx.lineTo(BARRIER_X + b.width/2, 100);
      ctx.lineTo(BARRIER_X + b.width/2 + 10, 90);
      ctx.lineTo(BARRIER_X - b.width/2 + 10, 90);
      ctx.fill();
      ctx.fillStyle = '#FFF';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(b.label, BARRIER_X, 80);
    }

    // --- DRAW DETECTOR ---
    ctx.fillStyle = '#333';
    ctx.fillRect(DETECTOR_X + 20, sourceY + 25, 10, 75);
    ctx.fillRect(DETECTOR_X + 5, sourceY + 95, 40, 5);

    const probeGrad = ctx.createLinearGradient(DETECTOR_X, sourceY - 25, DETECTOR_X, sourceY + 25);
    probeGrad.addColorStop(0, '#222');
    probeGrad.addColorStop(0.3, '#555');
    probeGrad.addColorStop(1, '#222');
    ctx.fillStyle = probeGrad;
    ctx.fillRect(DETECTOR_X, sourceY - 25, 80, 50);

    ctx.fillStyle = '#111';
    ctx.beginPath();
    ctx.ellipse(DETECTOR_X, sourceY, 10, 25, 0, Math.PI/2, Math.PI*1.5);
    ctx.fill();
    
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(DETECTOR_X - 5, sourceY - 15); ctx.lineTo(DETECTOR_X - 5, sourceY + 15);
    ctx.moveTo(DETECTOR_X, sourceY - 20); ctx.lineTo(DETECTOR_X, sourceY + 20);
    ctx.moveTo(DETECTOR_X - 8, sourceY - 5); ctx.lineTo(DETECTOR_X + 2, sourceY - 5);
    ctx.moveTo(DETECTOR_X - 8, sourceY + 5); ctx.lineTo(DETECTOR_X + 2, sourceY + 5);
    ctx.stroke();

    if (Date.now() - lastHitTimeRef.current < 100) {
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#FF5252';
        ctx.fillStyle = 'rgba(255, 82, 82, 0.8)';
        ctx.beginPath();
        ctx.ellipse(DETECTOR_X, sourceY, 8, 23, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    ctx.strokeStyle = '#111';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(DETECTOR_X + 80, sourceY);
    ctx.bezierCurveTo(DETECTOR_X + 100, sourceY, DETECTOR_X + 100, sourceY + 100, DETECTOR_X + 120, sourceY + 100);
    ctx.stroke();


    // --- PARTICLES ---
    if (timestamp - lastSpawnTimeRef.current > CONFIG[radiationType].spawnRate) {
      spawnParticle();
      lastSpawnTimeRef.current = timestamp;
    }

    particlesRef.current.forEach((p) => {
      if (!p.active) return;

      p.x += p.vx;

      let drawY = p.y;
      if (p.type === 'gamma') {
        drawY = p.y + Math.sin((p.x + p.waveOffset) * 0.1) * 5;
      }

      if (checkCollision(p)) {
        p.active = false;
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.beginPath();
        ctx.arc(p.x, drawY, p.type === 'alpha' ? 10 : 5, 0, Math.PI*2);
        ctx.fill();
      }

      if (p.x >= DETECTOR_X - 5) { 
        p.active = false;
        // Record hit time for Rate calculation
        hitHistoryRef.current.push(Date.now());
        // Increment raw total
        totalCountRef.current += 1;
        // Record hit time for visual flash
        lastHitTimeRef.current = Date.now();
      }

      if (p.x > CANVAS_WIDTH) p.active = false;

      if (p.active) {
        const pConfig = CONFIG[p.type];
        ctx.fillStyle = pConfig.color;
        
        if (p.type === 'alpha') {
          ctx.beginPath();
          ctx.arc(p.x - 3, drawY - 3, 3, 0, Math.PI*2);
          ctx.arc(p.x + 3, drawY - 3, 3, 0, Math.PI*2);
          ctx.arc(p.x - 3, drawY + 3, 3, 0, Math.PI*2);
          ctx.arc(p.x + 3, drawY + 3, 3, 0, Math.PI*2);
          ctx.fill();
        } else if (p.type === 'gamma') {
          ctx.strokeStyle = pConfig.color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(p.x - 10, drawY);
          ctx.lineTo(p.x, drawY);
          ctx.stroke();
        } else {
          ctx.beginPath();
          ctx.arc(p.x, drawY, pConfig.radius, 0, Math.PI*2);
          ctx.fill();
        }
      }
    });

    particlesRef.current = particlesRef.current.filter(p => p.active);
    animationRef.current = requestAnimationFrame(update);
  };

  useEffect(() => {
    animationRef.current = requestAnimationFrame(update);
    return () => cancelAnimationFrame(animationRef.current);
  }, [radiationType, barrierType, isPlaying]);

  const resetCount = () => {
      totalCountRef.current = 0;
      hitHistoryRef.current = [];
      setMetrics({ cpm: 0, cps: 0, uSv: 0, mrh: 0, total: 0 });
  };

  return (
    <div className="flex flex-col items-center justify-center p-4 bg-slate-900 min-h-screen text-white font-sans">
      
      <div className="w-full max-w-4xl bg-slate-800 rounded-xl shadow-2xl overflow-hidden border border-slate-700">
        
        {/* Header */}
        <div className="bg-slate-950 p-6 border-b border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Activity className="text-green-400" />
              Radiation Penetration Lab
            </h1>
            <p className="text-slate-400 text-sm mt-1">Explore how different particles interact with matter</p>
          </div>
          
          <div className="flex flex-col items-end gap-2 w-full md:w-auto">
             <div className="flex items-center gap-4 bg-slate-900 px-5 py-3 rounded-xl border border-slate-700 shadow-inner justify-between w-full md:w-auto">
                 
                 <div className="flex flex-col items-end min-w-[140px]">
                    <div className="flex items-end gap-2">
                         <span className={`text-4xl font-mono font-bold leading-none ${UNITS[selectedUnit].color}`}>
                            {metrics[selectedUnit]}
                         </span>
                         <span className="text-sm font-bold text-slate-500 mb-1">{UNITS[selectedUnit].label}</span>
                     </div>
                     <div className="text-[10px] text-slate-600 uppercase tracking-widest mt-1">
                        {UNITS[selectedUnit].name}
                     </div>
                 </div>

                 <div className="h-10 w-px bg-slate-700 mx-2"></div>

                 <button onClick={resetCount} className="p-2 hover:bg-slate-800 rounded-full transition-colors group" title="Reset Counter">
                    <RotateCcw size={20} className="text-slate-500 group-hover:text-slate-300" />
                 </button>
             </div>

             {/* Unit Selector */}
             <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700 gap-1">
                {Object.keys(UNITS).map(unit => (
                    <button
                        key={unit}
                        onClick={() => setSelectedUnit(unit)}
                        className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${
                            selectedUnit === unit 
                            ? 'bg-slate-700 text-white shadow-sm' 
                            : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'
                        }`}
                    >
                        {UNITS[unit].label}
                    </button>
                ))}
             </div>
          </div>
        </div>

        {/* Main Canvas Area */}
        <div className="relative bg-black w-full h-[400px] border-b border-slate-700 shadow-inner">
          <canvas 
            ref={canvasRef} 
            width={800} 
            height={400}
            className="w-full h-full object-contain"
          />
          
          {/* Legend Overlay */}
          <div className="absolute top-4 left-4 bg-slate-900/80 backdrop-blur p-3 rounded-lg border border-slate-700 text-xs shadow-lg">
            <div className="flex items-center gap-2 mb-1">
              <span className="w-3 h-3 rounded-full bg-[#FF5252]"></span> Alpha (Blocked by Paper)
            </div>
            <div className="flex items-center gap-2 mb-1">
              <span className="w-3 h-3 rounded-full bg-[#448AFF]"></span> Beta (Blocked by Alum.)
            </div>
            <div className="flex items-center gap-2">
              <span className="w-3 h-3 rounded-full bg-[#69F0AE]"></span> Gamma (Attenuated by Lead)
            </div>
          </div>
        </div>

        {/* Controls */}
        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 bg-slate-800">
          
          {/* Source Selection */}
          <div>
            <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
              <Radio size={16} /> Radiation Source
            </h3>
            <div className="flex gap-2">
              {['alpha', 'beta', 'gamma'].map((type) => (
                <button
                  key={type}
                  onClick={() => setRadiationType(type)}
                  className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all duration-200 border ${
                    radiationType === type 
                      ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-900/50' 
                      : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'
                  }`}
                >
                  {type.charAt(0).toUpperCase() + type.slice(1)}
                </button>
              ))}
            </div>
            <div className="mt-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700 min-h-[80px]">
                <p className="text-sm text-slate-300"><span className="font-bold text-indigo-400">Physics:</span> {CONFIG[radiationType].desc}</p>
            </div>
          </div>

          {/* Barrier Selection */}
          <div>
            <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
              <Shield size={16} /> Shielding Material
            </h3>
            <div className="grid grid-cols-4 gap-2">
              {Object.entries(BARRIERS).map(([key, config]) => (
                <button
                  key={key}
                  onClick={() => setBarrierType(key)}
                  className={`py-2 px-2 rounded-lg text-sm font-medium transition-all duration-200 border flex flex-col items-center justify-center gap-1 ${
                    barrierType === key 
                      ? 'bg-teal-600 border-teal-500 text-white shadow-lg shadow-teal-900/50' 
                      : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'
                  }`}
                >
                  <div 
                    className="w-full h-2 rounded-sm mb-1" 
                    style={{ backgroundColor: config.color === 'transparent' ? '#333' : config.color }}
                  ></div>
                  {config.label}
                </button>
              ))}
            </div>
             <div className="mt-3 flex gap-2">
                <button 
                    onClick={() => setIsPlaying(!isPlaying)}
                    className="flex-1 flex items-center justify-center gap-2 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 text-slate-200 transition-colors"
                >
                    {isPlaying ? <Pause size={16} /> : <Play size={16} />}
                    {isPlaying ? "Pause Simulation" : "Resume"}
                </button>
             </div>
          </div>

        </div>
      </div>
    </div>
  );
};

export default RadiationDemo;
